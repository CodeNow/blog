<!doctype html>
<html>

  <title>Runnablog</title>
  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="icon" type="image/png" href="/blog/favicon.png">
  <link rel="stylesheet" href="//runnable.com/styles/index.css">
  <link rel="stylesheet" href="/blog/css/index.css">
  <link rel="alternate" type="application/rss+xml" title="Runnable Blog" href="https://runnable.com/blog/feed.xml">
  <meta property="og:image" content="//s3-us-west-1.amazonaws.com/runnable-design/fb-image.png">
  <meta name="description" content="The official blog from the team at Runnable.">
  <meta name="twitter:card" content="summary">
  <meta name="twitter:site" content="@getrunnable">
  
    <meta name="twitter:title" content="9 Common Dockerfile Mistakes">
    <meta name="twitter:description" content="We work with Dockerfiles on a daily basis; all the code we run for ourselves and for our customers, we run from a set of Dockerfiles. In this article, weâ€™ll talk about what mistakes people commonly make, and how to write them better. For those of you who are Docker experts, a lot of the tips in this article will probably be pretty obvious and will just provoke a lot of head-nodding. But for beginner to intermediate developers, this will be a useful guide that will hopefully help clean and speed up your workflow.">
    
  <meta name="twitter:image" content="https://s3-us-west-1.amazonaws.com/runnable-design/tw-image.png">
  
</head>


  <body class="page-landing">

    <svg xmlns="http://www.w3.org/2000/svg" class="icon-defintions">
  <symbol id="icons-bitbucket" viewBox="0 0 27.438 31.681">
    <path d='M29.208,3.519a3.47,3.47,0,0,0-.729-0.738,8.244,8.244,0,0,0-2.01-1.1A21.7,21.7,0,0,0,21.768.45,39.134,39.134,0,0,0,10.037.434,24.268,24.268,0,0,0,6,1.385,10.419,10.419,0,0,0,3.525,2.549a4.165,4.165,0,0,0-.976.869,1.832,1.832,0,0,0-.4,1.479C2.32,5.989,2.48,7.082,2.66,8.169q0.4,2.417.811,4.828c0.306,1.787.62,3.573,0.918,5.36a2.026,2.026,0,0,0,.526,1.07,5.663,5.663,0,0,0,.574.543,9.178,9.178,0,0,0,2.432,1.354,20.379,20.379,0,0,0,6.485,1.328,25.257,25.257,0,0,0,4.838-.187,19.46,19.46,0,0,0,4.011-.948,10.809,10.809,0,0,0,2.725-1.382,4.323,4.323,0,0,0,.945-0.9,1.791,1.791,0,0,0,.354-0.805c0.4-2.341.809-4.679,1.2-7.021,0.362-2.172.7-4.346,1.058-6.518A1.78,1.78,0,0,0,29.208,3.519ZM15.82,19.64a4.361,4.361,0,1,1,4.386-4.334A4.359,4.359,0,0,1,15.82,19.64Zm8.7-15.246a1.832,1.832,0,0,1-.436.357,5.524,5.524,0,0,1-1.454.541,20.191,20.191,0,0,1-2.9.485,37.5,37.5,0,0,1-3.791.188,37.891,37.891,0,0,1-4.332-.238,15.852,15.852,0,0,1-3.146-.633,6.893,6.893,0,0,1-.883-0.381,1.385,1.385,0,0,1-.386-0.3A0.443,0.443,0,0,1,7.2,3.746,1.752,1.752,0,0,1,7.61,3.43a5.392,5.392,0,0,1,1.359-.512,20.355,20.355,0,0,1,2.994-.509,37.618,37.618,0,0,1,4.967-.172,30.478,30.478,0,0,1,4.55.431,10.33,10.33,0,0,1,2.075.545,5.336,5.336,0,0,1,.683.346,1.085,1.085,0,0,1,.288.266A0.422,0.422,0,0,1,24.522,4.394Zm1.664,18.367a0.955,0.955,0,0,1-.021.271c-0.305,1.6-.614,3.2-0.911,4.811a2.6,2.6,0,0,1-.724,1.377,5.442,5.442,0,0,1-1.448,1.023A12.151,12.151,0,0,1,20,31.274a18.806,18.806,0,0,1-3.563.407,20.746,20.746,0,0,1-5.917-.7,9.9,9.9,0,0,1-2.3-.953,5.078,5.078,0,0,1-1.042-.789,2.6,2.6,0,0,1-.741-1.4c-0.3-1.6-.609-3.207-0.915-4.81A1.12,1.12,0,0,1,5.5,22.79a0.479,0.479,0,0,1,.724-0.423c0.036,0.021.072,0.041,0.105,0.063a13.221,13.221,0,0,0,3.858,1.856,18.062,18.062,0,0,0,3.873.758,19.587,19.587,0,0,0,4.54-.11,16.41,16.41,0,0,0,5.687-1.827c0.354-.194.686-0.43,1.025-0.646a1.715,1.715,0,0,1,.167-0.1A0.48,0.48,0,0,1,26.186,22.761Zm-8.159-7.477a2.185,2.185,0,1,1-2.177-2.193A2.192,2.192,0,0,1,18.027,15.284Z', transform='translate(-2.122)'</<path d="M29.208,3.519a3.47,3.47,0,0,0-.729-0.738,8.244,8.244,0,0,0-2.01-1.1A21.7,21.7,0,0,0,21.768.45,39.134,39.134,0,0,0,10.037.434,24.268,24.268,0,0,0,6,1.385,10.419,10.419,0,0,0,3.525,2.549a4.165,4.165,0,0,0-.976.869,1.832,1.832,0,0,0-.4,1.479C2.32,5.989,2.48,7.082,2.66,8.169q0.4,2.417.811,4.828c0.306,1.787.62,3.573,0.918,5.36a2.026,2.026,0,0,0,.526,1.07,5.663,5.663,0,0,0,.574.543,9.178,9.178,0,0,0,2.432,1.354,20.379,20.379,0,0,0,6.485,1.328,25.257,25.257,0,0,0,4.838-.187,19.46,19.46,0,0,0,4.011-.948,10.809,10.809,0,0,0,2.725-1.382,4.323,4.323,0,0,0,.945-0.9,1.791,1.791,0,0,0,.354-0.805c0.4-2.341.809-4.679,1.2-7.021,0.362-2.172.7-4.346,1.058-6.518A1.78,1.78,0,0,0,29.208,3.519ZM15.82,19.64a4.361,4.361,0,1,1,4.386-4.334A4.359,4.359,0,0,1,15.82,19.64Zm8.7-15.246a1.832,1.832,0,0,1-.436.357,5.524,5.524,0,0,1-1.454.541,20.191,20.191,0,0,1-2.9.485,37.5,37.5,0,0,1-3.791.188,37.891,37.891,0,0,1-4.332-.238,15.852,15.852,0,0,1-3.146-.633,6.893,6.893,0,0,1-.883-0.381,1.385,1.385,0,0,1-.386-0.3A0.443,0.443,0,0,1,7.2,3.746,1.752,1.752,0,0,1,7.61,3.43a5.392,5.392,0,0,1,1.359-.512,20.355,20.355,0,0,1,2.994-.509,37.618,37.618,0,0,1,4.967-.172,30.478,30.478,0,0,1,4.55.431,10.33,10.33,0,0,1,2.075.545,5.336,5.336,0,0,1,.683.346,1.085,1.085,0,0,1,.288.266A0.422,0.422,0,0,1,24.522,4.394Zm1.664,18.367a0.955,0.955,0,0,1-.021.271c-0.305,1.6-.614,3.2-0.911,4.811a2.6,2.6,0,0,1-.724,1.377,5.442,5.442,0,0,1-1.448,1.023A12.151,12.151,0,0,1,20,31.274a18.806,18.806,0,0,1-3.563.407,20.746,20.746,0,0,1-5.917-.7,9.9,9.9,0,0,1-2.3-.953,5.078,5.078,0,0,1-1.042-.789,2.6,2.6,0,0,1-.741-1.4c-0.3-1.6-.609-3.207-0.915-4.81A1.12,1.12,0,0,1,5.5,22.79a0.479,0.479,0,0,1,.724-0.423c0.036,0.021.072,0.041,0.105,0.063a13.221,13.221,0,0,0,3.858,1.856,18.062,18.062,0,0,0,3.873.758,19.587,19.587,0,0,0,4.54-.11,16.41,16.41,0,0,0,5.687-1.827c0.354-.194.686-0.43,1.025-0.646a1.715,1.715,0,0,1,.167-0.1A0.48,0.48,0,0,1,26.186,22.761Zm-8.159-7.477a2.185,2.185,0,1,1-2.177-2.193A2.192,2.192,0,0,1,18.027,15.284Z" transform="translate(-2.122)"/>
  </symbol>
  <symbol id="icons-check" viewBox='0 0 14.5 10'>
    <path d="M7.25,14a1,1,0,0,1-.707-0.293l-4.5-4.5A1,1,0,0,1,3.457,7.793L7.25,11.586l7.293-7.293a1,1,0,0,1,1.414,1.414l-8,8A1,1,0,0,1,7.25,14Z" transform="translate(-1.75 -4)"/>
  </symbol>
  <symbol id="icons-chevron-right" viewBox='0 0 11 18'>
    <polyline points="1 1 10 9 1 17" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"/>
  </symbol>
  <symbol id="icons-chevron-down" viewBox='0 0 18 11'>
    <polyline points="17 1 9 10 1 1" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"></polyline>
  </symbol>
  <symbol id="icons-close" viewBox="0 0 30 30">
    <path d="M21,22.2c-0.3,0-0.5-0.1-0.7-0.3L15,16.6l-5.3,5.3c-0.4,0.4-1,0.4-1.4,0s-0.4-1,0-1.4l5.3-5.3L8.3,9.9c-0.4-0.4-0.4-1,0-1.4s1-0.4,1.4,0l5.3,5.3l5.3-5.3c0.4-0.4,1-0.4,1.4,0s0.4,1,0,1.4l-5.3,5.3l5.3,5.3c0.4,0.4,0.4,1,0,1.4C21.5,22.1,21.3,22.2,21,22.2z"/>
  </symbol>
  <symbol id="icons-external" viewBox="0 0 15 15">
    <path fill="currentColor" d="M9.5,9a0.5,0.5,0,0,1-.354-0.854L14.293,3H11a0.5,0.5,0,0,1,0-1h4.506a0.5,0.5,0,0,1,.32.121h0a0.56,0.56,0,0,1,.07.074,0.5,0.5,0,0,1,.1.269c0,0.013,0,.026,0,0.039V7a0.5,0.5,0,0,1-1,0V3.707L9.854,8.854A0.5,0.5,0,0,1,9.5,9Z" transform="translate(-1 -2)"/><path d="M13.317,8.218L13,8.535V14a2,2,0,0,1-2,2H4a2,2,0,0,1-2-2V7A2,2,0,0,1,4,5H9.465l0.317-.317A2.5,2.5,0,0,1,9.027,4H4A3,3,0,0,0,1,7v7a3,3,0,0,0,3,3h7a3,3,0,0,0,3-3V8.973A2.5,2.5,0,0,1,13.317,8.218Z" transform="translate(-1 -2)"/>
  </symbol>
  <symbol id="icons-github" viewBox="0 0 24 23.41">
    <path d="M24.336,7.791A12.011,12.011,0,0,1,25.52,23.366a12.083,12.083,0,0,1-5.883,4.313A0.686,0.686,0,0,1,19,27.549a0.648,0.648,0,0,1-.187-0.457l0.023-3.281a3.861,3.861,0,0,0-.258-1.395,2.219,2.219,0,0,0-.562-0.832,7.008,7.008,0,0,0,3.738-1.348Q23.41,19.03,23.5,15.655a5.127,5.127,0,0,0-.34-1.782,4.569,4.569,0,0,0-.9-1.43,3.254,3.254,0,0,0,.234-1.078,4.936,4.936,0,0,0-.352-2.109,1.719,1.719,0,0,0-.8.035A7.4,7.4,0,0,0,18.84,10.5a11.493,11.493,0,0,0-6,0,7.4,7.4,0,0,0-2.508-1.207,1.719,1.719,0,0,0-.8-0.035,4.936,4.936,0,0,0-.352,2.109,3.254,3.254,0,0,0,.234,1.078,4.569,4.569,0,0,0-.9,1.43,5.127,5.127,0,0,0-.34,1.782Q8.27,19.03,9.91,20.237a6.976,6.976,0,0,0,3.75,1.348,1.934,1.934,0,0,0-.48.633,3.414,3.414,0,0,0-.293.984,3.316,3.316,0,0,1-1.594.293,2.42,2.42,0,0,1-1.9-1.3,3.234,3.234,0,0,0-.645-0.75,1.767,1.767,0,0,0-1.184-.469q-0.7.023-.527,0.3a1.324,1.324,0,0,0,.551.469,2.583,2.583,0,0,1,.75.82,5.653,5.653,0,0,1,.469.867,2.2,2.2,0,0,0,.984,1.172,4.5,4.5,0,0,0,3.047.258l0.023,2.227a0.648,0.648,0,0,1-.187.457,0.686,0.686,0,0,1-.633.129A12.083,12.083,0,0,1,6.16,23.366,12,12,0,0,1,24.336,7.791Z" transform="translate(-3.84 -4.287)"/>
  </symbol>
  <symbol id="icons-life-preserver" viewBox='0 0 18 18'>
    <path d="M9,17A8,8,0,1,0,1,9,8,8,0,0,0,9,17ZM9,5A4,4,0,1,1,5,9,4,4,0,0,1,9,5Z" transform="translate(-1 -1)" fill="#fff"/><path d="M9,2A7,7,0,1,1,2,9,7.008,7.008,0,0,1,9,2M9,13.5A4.5,4.5,0,1,0,4.5,9,4.505,4.505,0,0,0,9,13.5M9,1a8,8,0,1,0,8,8A8,8,0,0,0,9,1H9ZM9,12.5A3.5,3.5,0,1,1,12.5,9,3.5,3.5,0,0,1,9,12.5H9Z" transform="translate(-1 -1)"/><path d="M5.259,7.623A3.989,3.989,0,0,1,7.623,5.259L4.654,2.289A8.032,8.032,0,0,0,2.29,4.653Z" transform="translate(-1 -1)"/><path d="M12.741,10.377a3.989,3.989,0,0,1-2.364,2.364l2.969,2.969a8.032,8.032,0,0,0,2.364-2.364Z" transform="translate(-1 -1)"/><path d="M7.623,12.741a3.989,3.989,0,0,1-2.364-2.364L2.289,13.346A8.032,8.032,0,0,0,4.653,15.71Z" transform="translate(-1 -1)"/><path d="M10.377,5.259a3.989,3.989,0,0,1,2.364,2.364l2.969-2.969A8.032,8.032,0,0,0,13.347,2.29Z" transform="translate(-1 -1)"/>
  </symbol>
  <symbol id="icons-overflow" viewBox="0 0 18 4.688">
    <path fill="currentColor" d="M2.344,7.656A1.344,1.344,0,1,1,1,9,1.345,1.345,0,0,1,2.344,7.656m0-1A2.344,2.344,0,1,0,4.688,9,2.344,2.344,0,0,0,2.344,6.656h0Z" transform="translate(0 -6.656)"/><path fill="currentColor" d="M9,7.656A1.344,1.344,0,1,1,7.656,9,1.345,1.345,0,0,1,9,7.656m0-1A2.344,2.344,0,1,0,11.344,9,2.344,2.344,0,0,0,9,6.656H9Z" transform="translate(0 -6.656)"/><path fill="currentColor" d="M15.656,7.656A1.344,1.344,0,1,1,14.313,9a1.345,1.345,0,0,1,1.344-1.344m0-1A2.344,2.344,0,1,0,18,9a2.344,2.344,0,0,0-2.344-2.344h0Z" transform="translate(0 -6.656)"/>
  </symbol>
</svg>

    <header class="grid-block shrink header">
  <div class="grid-block grid-container justify-justified">
    <a href="/" class="grid-content shrink logo">
      <img class="img" src="https://runnable.com/images/runnable-logo.svg" height="36" width="192">
    </a>
    <nav class="nav grid-block shrink">
      <a href="/docs/" class="grid-content btn btn-sm text-white weight-strong hidden-xs a">Docs</a>
      <a href="/product/" class="grid-content btn btn-sm text-white weight-strong hidden-sm a">Product</a>
      <a href="/pricing/" class="grid-content btn btn-sm text-white weight-strong hidden-md">Pricing</a>
      <a href="/signin" class="grid-content btn btn-sm text-white weight-strong hidden-md js-hide-if-signed-in">Sign In</a>
      <a href="/signup" class="grid-content btn btn-sm btn-white text-white weight-strong hidden-xs js-hide-if-signed-in track-sign-up">Sign Up</a>
      <div class="grid-content btn btn-sm btn-overflow popover-trigger hover has-links" tabindex="1">
        <svg class="icons icons-overflow">
          <use xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="#icons-overflow"></use>
        </svg>
        <div class="popover-hover-wrapper right-align-sm">
  <div class="grid-block popover popover-header-menu bottom">
    <div class="grid-block col list text-left">
      <a data-target="#sign-up" class="list-item-a visible-xs js-hide-if-signed-in track-sign-up">Sign Up</a>
      <a data-target="#sign-in" class="list-item-a visible-md js-hide-if-signed-in">Sign In</a>
      <div class="list-item divider visible-md"></div>
      <a href="/docs/" class="list-item-a visible-xs">Docs</a>
      <a href="/for/" class="list-item-a visible-sm">Product</a>
      <a href="/pricing/" class="list-item-a visible-md"><span class="text-request">Pricing</a>
      <a href="/how-it-works/" class="list-item-a">How It Works</a>
      <a href="/demo/" class="list-item-a">Request Demo</a>
      <a href="/blog/" class="list-item-a">Blog</a>
      <a href="/about/" class="list-item-a">About</a>
    </div>
  </div>
</div>

      </div>
    </nav>
  </div>
</header>


    <main class="grid-block col main">
      <div class="grid-block col align-center hero">
  <h1 class="h1 text-center weight-strong margin-top-sm">9 Common Dockerfile Mistakes</h1>
</div>

<div class="grid-block grid-container col noscroll">
  <div class="grid-block align-center col post-details">
    
    <img class="avatar" src="images/authors/jorgesilva.jpg" width="45" height="45">
    <div>by Jorge Silva</div>
    <div>7 months ago in Engineering</div>
    <div class="grid-block social-sharing" data-url="http://runnable.com/blog/9-common-dockerfile-mistakes" data-legacy-url="http://blog.runnable.com/post/145895165446/9-common-dockerfile-mistakes">
      <a target="_blank" href="http://twitter.com/intent/tweet?url=http://runnable.com/blog/9-common-dockerfile-mistakes&via=GetRunnable" class="share-item share-twitter">
        <img src="images/logos/logo-twitter.svg" width="20" height="20">
        <span class="share-count small">0</span>
      </a>
      <a target="_blank" href="http://www.linkedin.com/shareArticle?mini=true&url=http://runnable.com/blog/9-common-dockerfile-mistakes" class="share-item share-linkedin">
        <img src="images/logos/logo-linkedin.svg" width="20" height="20">
        <span class="share-count small">0</span>
      </a>
      <a target="_blank" href="#" class="share-item share-hackernews hidden">
        <img src="images/logos/logo-hackernews.svg" width="20" height="20">
        <span class="share-count small">0</span>
      </a>
    </div>
  </div>
  <article class="article article-body">
    <p class="p">We work with Dockerfiles on a daily basis; all the code we run for ourselves and for our customers, we run from a set of Dockerfiles. In this article, weâ€™ll talk about what mistakes people commonly make, and how to write them better. For those of you who are Docker experts, a lot of the tips in this article will probably be pretty obvious and will just provoke a lot of head-nodding. But for beginner to intermediate developers, this will be a useful guide that will hopefully help clean and speed up your workflow.</p>

<h3 class="h3">1. Running apt-get</h3>

<p class="p">Running <code class="monospace">apt-get install</code> is one of those things virtually every Dockerfile will have. You will probably need to install some external package in order to run your code. But using <code class="monospace">apt-get</code> comes with its fair share of gotchas.</p>

<p class="p">The first is running <code class="monospace">apt-get upgrade</code>. This will update all your packages to their latests versions â€” which is bad because it prevents your Dockerfile from creating consistent, immutable builds.</p>

<p class="p">Another issue is with running <code class="monospace">apt-get update</code> in a different line than running your <code class="monospace">apt-get install</code> command. The reason why this is bad is because a line with only <code class="monospace">apt-get update</code> will get cached by the build and won't actually run every time you need to run <code class="monospace">apt-get install</code>. Instead, make sure you run <code class="monospace">apt-get update</code> in the same line with all the packages to ensure all are updated correctly.</p>

<p class="p">The <code class="monospace">apt-install</code> in the <a href="https://github.com/docker-library/golang/blob/master/1.7/Dockerfile#L4" class="link" target="_blank">Golang Dockerfile</a> is a good example of how this should be done:</p>

<pre class="pre"><code class="monospace no-wrap"># From https://github.com/docker-library/golang
RUN apt-get update &amp;&amp; \
  apt-get install -y --no-install-recommends \
  g++ \
  gcc \
  libc6-dev \
  make \
  &amp;&amp; rm -rf /var/lib/apt/lists/*</code></pre>

<h3 class="h3">2. Using ADD instead of COPY</h3>

<p class="p">While similar, <code class="monospace">ADD</code> and <code class="monospace">COPY</code> are actually different commands. <code class="monospace">COPY</code> is the simplest of the two, since it just copies a file or a directory from your host to your image. <code class="monospace">ADD</code> does this too, but also has some more magical features like extracting TAR files or fetching files from remote URLs. In order to reduce the complexity of your Dockerfile and prevent some unexpected behavior, it's usually best to always use <code class="monospace">COPY</code> to copy your files.</p>

<pre class="pre"><code class="monospace no-wrap">FROM busybox:1.24

ADD example.tar.gz /add # Will untar the file into the ADD directory
COPY example.tar.gz /copy # Will copy the file directly</code></pre>

<h3 class="h3">3. Adding your entire application directory in one line</h3>

<p class="p">Being explicit about what part of your code should be included in your build, and at what time, might be the most important thing you can do to significantly speed up your builds.</p>

<p class="p">Often times, when looking at a Dockerfile, you'll see this:</p>

<pre class="pre"><code class="monospace no-wrap"># !!! ANTIPATTERN !!!
COPY ./my-app/ /home/app/
RUN npm install # or RUN pip install or RUN bundle install
# !!! ANTIPATTERN !!!</code></pre>

<p class="p">This means that every time we make a change to any of our files, weâ€™ll have to rebuild everything below that line. In most cases (including the example above), this means having to re-install our application dependencies. In order to use Dockerâ€™s cache as smartly as possible, copy over the files that are needed to install all your dependencies first, and then execute the commands that install those dependencies. Doing those two steps before copying over the rest of your application files (which should be done at the latest possible line) will enable your changes to be quickly re-built.</p>

<pre class="pre"><code class="monospace no-wrap">COPY ./my-app/package.json /home/app/package.json # Node/npm packages
WORKDIR /home/app/
RUN npm install

# Maybe you have to install python packages too?
COPY ./my-app/requirements.txt /home/app/requirements.txt
RUN pip install -r requirements.txt
COPY ./my-app/ /home/app/</code></pre>

<p class="p">This will ensure that your builds run as fast as possible.</p>

<h3 class="h3">4. Using :latest</h3>

<p class="p">Many Dockerfiles use the <code class="monospace">FROM node:latest</code> pattern at the top of their Dockerfiles to pull the latest image from a Docker registry. While simple, using the <code class="monospace">latest</code> tag for an image means that your build can suddenly break if that image gets updated. Figuring this out might prove to be very difficult, since the maintainer of the Dockerfile didnâ€™t actually make any changes. To prevent this, just make sure you use a specific tag of an image (example: <code class="monospace">node:6.2.1</code>). This will ensure your Dockerfile remains immutable.</p>

<h3 class="h3">5. Using external services during the build</h3>

<p class="p">Many people forget the difference between building a Docker image and running a Docker container. When building an image, Docker reads the commands in your Dockerfile and creates an image from it. Your image should be immutable and reusable until any of your dependencies or your code changes. This process should be completely independent of any other container. Anything that requires interaction with other containers or other services (like a database) should happen when you run the container.</p>

<p class="p">An example of this is running a database migration. Most people attempt to run these when they are building their image. This has a couple of problems. First, the database might not be available during build time, since it might not be built on the same server that it will be running on. Second, you might want to use this same image to connect to different databases (development vs production), at which point the migration would not run if itâ€™s in the build.</p>

<pre class="pre"><code class="monospace no-wrap"># !!! ANTIPATTERN !!!
COPY /YOUR-PROJECT /YOUR-PROJECT
RUN python manage.py migrate

# runserver would actually try to the migration, but imagine it doesnâ€™t
CMD ["python", "manage.py", "runserver", "0.0.0.0:8000"]
# !!! ANTIPATTERN !!!</code></pre>

<h3 class="h3">6. Adding EXPOSE and ENV at the top of your Dockerfile</h3>

<p class="p"><code class="monospace">EXPOSE</code> and <code class="monospace">ENV</code> are cheap commands to run. If you bust the cache for them, rebuilding them is almost instantaneous. Therefore, itâ€™s best to declare these commands as late as possible. You should only ever declare <code class="monospace">ENV</code>s whenever you need them in your build process. If theyâ€™re not needed during build time, then they should be at the end of your Dockerfile, along with <code class="monospace">EXPOSE</code>.</p>

<p class="p">If you look at the Go Dockerfile again, you'll see that they declare all the <code class="monospace">ENV</code>s they need before using them and declare all other at the end:</p>

<pre class="pre"><code class="monospace no-wrap">ENV GOLANG_VERSION 1.7beta1
ENV GOLANG_DOWNLOAD_URL https://golang.org/dl/go$GOLANG_VERSION.linux-amd64.tar.gz
ENV GOLANG_DOWNLOAD_SHA256 a55e718935e2be1d5b920ed262fd06885d2d7fc4eab7722aa02c205d80532e3b

RUN curl -fsSL "$GOLANG_DOWNLOAD_URL" -o golang.tar.gz \
 &amp;&amp; echo "$GOLANG_DOWNLOAD_SHA256  golang.tar.gz" | sha256sum -c - \
 &amp;&amp; tar -C /usr/local -xzf golang.tar.gz \
 &amp;&amp; rm golang.tar.gz

ENV GOPATH /go
ENV PATH $GOPATH/bin:/usr/local/go/bin:$PATH</code></pre>

<p class="p">If they need to change the <code class="monospace">ENV GOPATH</code> or <code class="monospace">ENV PATH</code>, their image will get rebuilt almost immediately.</p>

<h3 class="h3">7. Multiple FROM statements</h3>

<p class="p">It might be tempting to try to combine different images together by using multiple <code class="monospace">FROM</code> statements; this wonâ€™t work. Instead, Docker will just use the last <code class="monospace">FROM</code> specified and ignore everything before that.</p>

<p class="p">So if you have this Dockerfile:</p>

<pre class="pre"><code class="monospace no-wrap"># !!! ANTIPATTERN !!!
FROM node:6.2.1
FROM python:3.5

CMD ["sleep", "infinity"]
# !!! ANTIPATTERN !!!</code></pre>

<p class="p">And then <code class="monospace">docker exec</code> into that running container, you'll notice the following:</p>

<pre class="pre"><code class="monospace no-wrap">$ docker exec -it d86fcf0775d3 bash
root@d86fcf0775d3:/# which python
/usr/local/bin/python
root@d86fcf0775d3:/# which node
root@d86fcf0775d3:/#</code></pre>

<p class="p">There is actually a GitHub issue for combining different images together, but this does not look like a feature that will be added any time soon.</p>

<h3 class="h3">8. Multiple services running in the same container</h3>

<p class="p">This is probably the biggest head-nodder for people who already know Docker. It's a well established best-practice that every different service which composes your application should run in its own container. It's tempting to add multiple services to one docker image, but this practice has some downsides.</p>

<p class="p">First, you'll make it more difficult to horizontally scale your application. Second, the additional dependencies and layers will make your build slower. Finally, it'll make your Dockerfile harder to write, maintain, and debug.</p>

<p class="p">Of course, as with all technical advice, youâ€™ll need to use your best judgement. If you want to quickly setup a Django+Nginx application for development, it might make sense to just run them in the same container and have a different Dockerfile in production where they run separately.</p>

<h3 class="h3">9. Using VOLUME in your build process</h3>

<p class="p">Volumes in your image are added when you run your container, not when you build it. In a similar way to #5, you should never interact with your declared volume in your build process. Rather, you should only use it when you run the container.</p>

<p class="p">For example, if I create a file in my build process and use that file when I run that image, everything works fine:</p>

<pre class="pre"><code class="monospace no-wrap">FROM busybox:1.24
RUN echo "hello-world!!!!" &gt; /myfile.txt

CMD ["cat", "/myfile.txt"]

$ docker run volume-in-build
hello-world!!!!</code></pre>

<p class="p">On the other hand, if I do the same thing for a file stored in a volume, it won't work.</p>

<pre class="pre"><code class="monospace no-wrap">FROM busybox:1.24
VOLUME /data
RUN echo "hello-world!!!!" &gt; /data/myfile.txt

CMD ["cat", "/data/myfile.txt"]

$ docker run volume-in-build
cat: can't open '/data/myfile.txt': No such file or directory</code></pre>

<p class="p">An interesting gotcha for this is that if any of your previous layers has a <code class="monospace">VOLUME</code> declaration (which might be several <code class="monospace">FROM</code>s away) you will still run into the same issue. For that reason, it's a good idea to be aware of what volumes your parent images declare. Use <code class="monospace">docker inspect</code> if you run into problems.</p>

<h3 class="h3">Conclusion</h3>

<p class="p">Understanding how to write a good Dockerfile will take you a long way into understanding how Docker works and will also help you in abstracting your infrastructure. Understanding the Docker cache alone will save you hours and hours of waiting for a build to finish over time!</p>

  </article>

  <section class="grid-block col shrink justify-center align-center section-footer">
    <a class="grid-block shrink link text-center margin-bottom-lg margin-top-lg" href="/blog/">View All Posts</a>
    <div id="mc_embed_signup" class="grid-block justify-center">
  <form action="//runnable.us5.list-manage.com/subscribe/post?u=a67ad168d3259d6b0f4d103df&amp;id=504370029e" method="post" id="mc-embedded-subscribe-form" name="mc-embedded-subscribe-form" class="validate" target="_blank" novalidate="">
    <div id="mc_embed_signup_scroll" class="grid-block col-xs mailchimp-form">
      <div class="mc-field-group">
        <input type="email" value="" name="EMAIL" class="input input-md" id="mce-EMAIL" placeholder="Your email">
      </div>
      <div id="mce-responses" class="clear">
        <div class="response" id="mce-error-response" style="display:none"></div>
        <div class="response" id="mce-success-response" style="display:none"></div>
      </div>
      <!-- real people should not fill this in and expect good things - do not remove this or risk form bot signups-->
      <div style="position: absolute; left: -5000px;" aria-hidden="true">
        <input type="text" name="b_a67ad168d3259d6b0f4d103df_504370029e" tabindex="-1" value="">
      </div>
      <div class="clear grid-block justify-center">
        <input type="submit" value="Subscribe to New Posts" name="subscribe" id="mc-embedded-subscribe" class="btn btn-md gray">
      </div>
    </div>
  </form>
</div>
  </section>
</div>

<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.11.0/jquery.min.js"></script>
<script src="js/social-buttons.js"></script>

    </main>

    <footer class="grid-block col footer justify-spaced">
  <a href="https://runnable.com/signup" class="sign-up-box grid-block col well well-anchor track-sign-up">
  <img class="img no-touching" src="/blog/images/runnabear-hello.png">
  <p class="p">Try Runnable! Itâ€™s <strong class="weight-strong">free</strong> for 14 days.
  <div data-target="#sign-up" class="btn btn-sm green track-sign-up">Sign Up</div>
</a>

  <aside class="grid-block aside-support">
  <div class="grid-block col justify-center support-text">
    <p class="p weight-strong">Our engineers are here for you.</p>
    <p class="p">We can answer questions about Docker <br class="br">and help you set up your stack.</p>
  </div>
  <figure class="grid-block col figure shrink">
    <div class="grid-block shrink bubble">
      <img class="img float-left" src="/blog/images/logos/logo-slack.svg" height="18" width="18" alt="Slack">
      <div class="grid-block col">
        <div class="user">
          <strong class="strong user-name">Jorge</strong>
          <span class="user-time"> 4:19 PM</span>
        </div>
        <p class="p user-text">Can I run multiple commands?</p>
      </div>
    </div>
    <div class="grid-block shrink bubble">
      <img class="img float-left" src="/blog/images/runnabot-head.png" height="18" width="18" alt="Slack">
      <div class="grid-block col">
        <div class="user">
          <strong class="strong user-name">Taylor</strong>
          <span class="user-time"> 4:20 PM</span>
        </div>
        <p class="p user-text">Hi <span class="link-blue">@jorge</span>!
          <br>Yes you can. Hereâ€™s how: â€¦
        </p>
      </div>
    </div>
  </figure>
</aside>

  <div class="grid-block link-wrapper">
    <div class="grid-block col align-start">
      <a href="/docs/" class="btn btn-xs link weight-strong">Docs</a>
      <a href="/for/" class="btn btn-xs link weight-strong">Product</a>
      <a href="/pricing/" class="btn btn-xs link weight-strong">Pricing</a>
      <a href="/how-it-works/" class="btn btn-xs link weight-strong">How It Works</a>
      <a href="https://runnable.com/docker/" class="btn btn-xs link weight-strong">Docker Guides</a>
      <a href="/demo/" class="btn btn-xs link weight-strong">Request Demo</a>
    </div>
    <div class="grid-block col align-start">
      <a href="https://runnable.com/use-cases/" class="btn btn-xs link weight-strong">Use Cases</a>
      <a href="/blog/" class="btn btn-xs link weight-strong">Blog</a>
      <a href="/about/" class="btn btn-xs link weight-strong">About</a>
      <a href="/legal/privacy-policy/" class="btn btn-xs link weight-strong">Privacy</a>
      <a href="/legal/terms-of-service/" class="btn btn-xs link weight-strong">Terms</a>
      <a href="/legal/acceptable-use-policy/" class="btn btn-xs link weight-strong">Acceptable Use</a>
    </div>
  </div>
</footer>


  </body>

</html>
