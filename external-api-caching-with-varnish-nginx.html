<!doctype html>
<html>

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="icon" type="image/png" href="/blog/favicon.png">
  <link rel="stylesheet" href="//runnable.com/styles/index.css">
  <link rel="stylesheet" href="/blog/css/index.css">
  <meta property="og:image" content="//s3-us-west-1.amazonaws.com/runnable-design/fb-image.png">
  
    <meta name="twitter:title" content="External API Caching with Varnish & Nginx">
    <meta name="twitter:description" content="We use a number of external services to handle data retrieval, monitoring, and reporting. The importance of each service depends on its role in our sandboxes product. For instance, it’s generally fine if we miss a few reports sent to Datadog but it is not okay if we are unable to reach the GitHub API. In this post, we’ll discuss the issues we’ve faced when interfacing with external services and dive into how we use Varnish Cache to handle them.">
    
  <meta name="twitter:image" content="https://s3-us-west-1.amazonaws.com/runnable-design/tw-image.png">
  <script src="//runnable.com/js/external/segment.js"></script>
  <!-- Begin Jekyll SEO tag v2.1.0 -->
<title>External API Caching with Varnish &amp; Nginx - Runnablog</title>
<meta property="og:title" content="External API Caching with Varnish &amp; Nginx" />
<meta name="description" content="We use a number of external services to handle data retrieval, monitoring, and reporting. The importance of each service depends on its role in our sandboxes product. For instance, it’s generally fine if we miss a few reports sent to Datadog but it is not okay if we are unable to reach the GitHub API. In this post, we’ll discuss the issues we’ve faced when interfacing with external services and dive into how we use Varnish Cache to handle them." />
<meta property="og:description" content="We use a number of external services to handle data retrieval, monitoring, and reporting. The importance of each service depends on its role in our sandboxes product. For instance, it’s generally fine if we miss a few reports sent to Datadog but it is not okay if we are unable to reach the GitHub API. In this post, we’ll discuss the issues we’ve faced when interfacing with external services and dive into how we use Varnish Cache to handle them." />
<link rel="canonical" href="https://runnable.com/blog/external-api-caching-with-varnish-nginx" />
<meta property="og:url" content="https://runnable.com/blog/external-api-caching-with-varnish-nginx" />
<meta property="og:site_name" content="Runnablog" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2016-05-31T00:00:00-07:00" />
<meta name="twitter:card" content="summary" />
<meta name="twitter:site" content="@GetRunnable" />
<meta name="twitter:creator" content="@rsandor" />
<meta property="article:publisher" content="Runnable" />
<script type="application/ld+json">
{"@context": "http://schema.org",
"@type": "BlogPosting",
"headline": "External API Caching with Varnish &amp; Nginx",
"datePublished": "2016-05-31T00:00:00-07:00",
"description": "We use a number of external services to handle data retrieval, monitoring, and reporting. The importance of each service depends on its role in our sandboxes product. For instance, it’s generally fine if we miss a few reports sent to Datadog but it is not okay if we are unable to reach the GitHub API. In this post, we’ll discuss the issues we’ve faced when interfacing with external services and dive into how we use Varnish Cache to handle them.",
"url": "https://runnable.com/blog/external-api-caching-with-varnish-nginx"}</script>
<!-- End Jekyll SEO tag -->

  <link type="application/atom+xml" rel="alternate" href="https://runnable.com/blog/feed.xml" title="Runnablog" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.17.1/moment.min.js"></script>
  <script src="/blog/js/post-time.js"></script>
</head>


  <body class="page-landing">

    <svg xmlns="http://www.w3.org/2000/svg" class="icon-defintions">
  <symbol id="icons-bitbucket" viewBox="0 0 27.438 31.681">
    <path d='M29.208,3.519a3.47,3.47,0,0,0-.729-0.738,8.244,8.244,0,0,0-2.01-1.1A21.7,21.7,0,0,0,21.768.45,39.134,39.134,0,0,0,10.037.434,24.268,24.268,0,0,0,6,1.385,10.419,10.419,0,0,0,3.525,2.549a4.165,4.165,0,0,0-.976.869,1.832,1.832,0,0,0-.4,1.479C2.32,5.989,2.48,7.082,2.66,8.169q0.4,2.417.811,4.828c0.306,1.787.62,3.573,0.918,5.36a2.026,2.026,0,0,0,.526,1.07,5.663,5.663,0,0,0,.574.543,9.178,9.178,0,0,0,2.432,1.354,20.379,20.379,0,0,0,6.485,1.328,25.257,25.257,0,0,0,4.838-.187,19.46,19.46,0,0,0,4.011-.948,10.809,10.809,0,0,0,2.725-1.382,4.323,4.323,0,0,0,.945-0.9,1.791,1.791,0,0,0,.354-0.805c0.4-2.341.809-4.679,1.2-7.021,0.362-2.172.7-4.346,1.058-6.518A1.78,1.78,0,0,0,29.208,3.519ZM15.82,19.64a4.361,4.361,0,1,1,4.386-4.334A4.359,4.359,0,0,1,15.82,19.64Zm8.7-15.246a1.832,1.832,0,0,1-.436.357,5.524,5.524,0,0,1-1.454.541,20.191,20.191,0,0,1-2.9.485,37.5,37.5,0,0,1-3.791.188,37.891,37.891,0,0,1-4.332-.238,15.852,15.852,0,0,1-3.146-.633,6.893,6.893,0,0,1-.883-0.381,1.385,1.385,0,0,1-.386-0.3A0.443,0.443,0,0,1,7.2,3.746,1.752,1.752,0,0,1,7.61,3.43a5.392,5.392,0,0,1,1.359-.512,20.355,20.355,0,0,1,2.994-.509,37.618,37.618,0,0,1,4.967-.172,30.478,30.478,0,0,1,4.55.431,10.33,10.33,0,0,1,2.075.545,5.336,5.336,0,0,1,.683.346,1.085,1.085,0,0,1,.288.266A0.422,0.422,0,0,1,24.522,4.394Zm1.664,18.367a0.955,0.955,0,0,1-.021.271c-0.305,1.6-.614,3.2-0.911,4.811a2.6,2.6,0,0,1-.724,1.377,5.442,5.442,0,0,1-1.448,1.023A12.151,12.151,0,0,1,20,31.274a18.806,18.806,0,0,1-3.563.407,20.746,20.746,0,0,1-5.917-.7,9.9,9.9,0,0,1-2.3-.953,5.078,5.078,0,0,1-1.042-.789,2.6,2.6,0,0,1-.741-1.4c-0.3-1.6-.609-3.207-0.915-4.81A1.12,1.12,0,0,1,5.5,22.79a0.479,0.479,0,0,1,.724-0.423c0.036,0.021.072,0.041,0.105,0.063a13.221,13.221,0,0,0,3.858,1.856,18.062,18.062,0,0,0,3.873.758,19.587,19.587,0,0,0,4.54-.11,16.41,16.41,0,0,0,5.687-1.827c0.354-.194.686-0.43,1.025-0.646a1.715,1.715,0,0,1,.167-0.1A0.48,0.48,0,0,1,26.186,22.761Zm-8.159-7.477a2.185,2.185,0,1,1-2.177-2.193A2.192,2.192,0,0,1,18.027,15.284Z', transform='translate(-2.122)'</<path d="M29.208,3.519a3.47,3.47,0,0,0-.729-0.738,8.244,8.244,0,0,0-2.01-1.1A21.7,21.7,0,0,0,21.768.45,39.134,39.134,0,0,0,10.037.434,24.268,24.268,0,0,0,6,1.385,10.419,10.419,0,0,0,3.525,2.549a4.165,4.165,0,0,0-.976.869,1.832,1.832,0,0,0-.4,1.479C2.32,5.989,2.48,7.082,2.66,8.169q0.4,2.417.811,4.828c0.306,1.787.62,3.573,0.918,5.36a2.026,2.026,0,0,0,.526,1.07,5.663,5.663,0,0,0,.574.543,9.178,9.178,0,0,0,2.432,1.354,20.379,20.379,0,0,0,6.485,1.328,25.257,25.257,0,0,0,4.838-.187,19.46,19.46,0,0,0,4.011-.948,10.809,10.809,0,0,0,2.725-1.382,4.323,4.323,0,0,0,.945-0.9,1.791,1.791,0,0,0,.354-0.805c0.4-2.341.809-4.679,1.2-7.021,0.362-2.172.7-4.346,1.058-6.518A1.78,1.78,0,0,0,29.208,3.519ZM15.82,19.64a4.361,4.361,0,1,1,4.386-4.334A4.359,4.359,0,0,1,15.82,19.64Zm8.7-15.246a1.832,1.832,0,0,1-.436.357,5.524,5.524,0,0,1-1.454.541,20.191,20.191,0,0,1-2.9.485,37.5,37.5,0,0,1-3.791.188,37.891,37.891,0,0,1-4.332-.238,15.852,15.852,0,0,1-3.146-.633,6.893,6.893,0,0,1-.883-0.381,1.385,1.385,0,0,1-.386-0.3A0.443,0.443,0,0,1,7.2,3.746,1.752,1.752,0,0,1,7.61,3.43a5.392,5.392,0,0,1,1.359-.512,20.355,20.355,0,0,1,2.994-.509,37.618,37.618,0,0,1,4.967-.172,30.478,30.478,0,0,1,4.55.431,10.33,10.33,0,0,1,2.075.545,5.336,5.336,0,0,1,.683.346,1.085,1.085,0,0,1,.288.266A0.422,0.422,0,0,1,24.522,4.394Zm1.664,18.367a0.955,0.955,0,0,1-.021.271c-0.305,1.6-.614,3.2-0.911,4.811a2.6,2.6,0,0,1-.724,1.377,5.442,5.442,0,0,1-1.448,1.023A12.151,12.151,0,0,1,20,31.274a18.806,18.806,0,0,1-3.563.407,20.746,20.746,0,0,1-5.917-.7,9.9,9.9,0,0,1-2.3-.953,5.078,5.078,0,0,1-1.042-.789,2.6,2.6,0,0,1-.741-1.4c-0.3-1.6-.609-3.207-0.915-4.81A1.12,1.12,0,0,1,5.5,22.79a0.479,0.479,0,0,1,.724-0.423c0.036,0.021.072,0.041,0.105,0.063a13.221,13.221,0,0,0,3.858,1.856,18.062,18.062,0,0,0,3.873.758,19.587,19.587,0,0,0,4.54-.11,16.41,16.41,0,0,0,5.687-1.827c0.354-.194.686-0.43,1.025-0.646a1.715,1.715,0,0,1,.167-0.1A0.48,0.48,0,0,1,26.186,22.761Zm-8.159-7.477a2.185,2.185,0,1,1-2.177-2.193A2.192,2.192,0,0,1,18.027,15.284Z" transform="translate(-2.122)"/>
  </symbol>
  <symbol id="icons-check" viewBox='0 0 14.5 10'>
    <path d="M7.25,14a1,1,0,0,1-.707-0.293l-4.5-4.5A1,1,0,0,1,3.457,7.793L7.25,11.586l7.293-7.293a1,1,0,0,1,1.414,1.414l-8,8A1,1,0,0,1,7.25,14Z" transform="translate(-1.75 -4)"/>
  </symbol>
  <symbol id="icons-chevron-right" viewBox='0 0 11 18'>
    <polyline points="1 1 10 9 1 17" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"/>
  </symbol>
  <symbol id="icons-chevron-down" viewBox='0 0 18 11'>
    <polyline points="17 1 9 10 1 1" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"></polyline>
  </symbol>
  <symbol id="icons-close" viewBox="0 0 30 30">
    <path d="M21,22.2c-0.3,0-0.5-0.1-0.7-0.3L15,16.6l-5.3,5.3c-0.4,0.4-1,0.4-1.4,0s-0.4-1,0-1.4l5.3-5.3L8.3,9.9c-0.4-0.4-0.4-1,0-1.4s1-0.4,1.4,0l5.3,5.3l5.3-5.3c0.4-0.4,1-0.4,1.4,0s0.4,1,0,1.4l-5.3,5.3l5.3,5.3c0.4,0.4,0.4,1,0,1.4C21.5,22.1,21.3,22.2,21,22.2z"/>
  </symbol>
  <symbol id="icons-external" viewBox="0 0 15 15">
    <path fill="currentColor" d="M9.5,9a0.5,0.5,0,0,1-.354-0.854L14.293,3H11a0.5,0.5,0,0,1,0-1h4.506a0.5,0.5,0,0,1,.32.121h0a0.56,0.56,0,0,1,.07.074,0.5,0.5,0,0,1,.1.269c0,0.013,0,.026,0,0.039V7a0.5,0.5,0,0,1-1,0V3.707L9.854,8.854A0.5,0.5,0,0,1,9.5,9Z" transform="translate(-1 -2)"/><path d="M13.317,8.218L13,8.535V14a2,2,0,0,1-2,2H4a2,2,0,0,1-2-2V7A2,2,0,0,1,4,5H9.465l0.317-.317A2.5,2.5,0,0,1,9.027,4H4A3,3,0,0,0,1,7v7a3,3,0,0,0,3,3h7a3,3,0,0,0,3-3V8.973A2.5,2.5,0,0,1,13.317,8.218Z" transform="translate(-1 -2)"/>
  </symbol>
  <symbol id="icons-github" viewBox="0 0 24 23.41">
    <path d="M24.336,7.791A12.011,12.011,0,0,1,25.52,23.366a12.083,12.083,0,0,1-5.883,4.313A0.686,0.686,0,0,1,19,27.549a0.648,0.648,0,0,1-.187-0.457l0.023-3.281a3.861,3.861,0,0,0-.258-1.395,2.219,2.219,0,0,0-.562-0.832,7.008,7.008,0,0,0,3.738-1.348Q23.41,19.03,23.5,15.655a5.127,5.127,0,0,0-.34-1.782,4.569,4.569,0,0,0-.9-1.43,3.254,3.254,0,0,0,.234-1.078,4.936,4.936,0,0,0-.352-2.109,1.719,1.719,0,0,0-.8.035A7.4,7.4,0,0,0,18.84,10.5a11.493,11.493,0,0,0-6,0,7.4,7.4,0,0,0-2.508-1.207,1.719,1.719,0,0,0-.8-0.035,4.936,4.936,0,0,0-.352,2.109,3.254,3.254,0,0,0,.234,1.078,4.569,4.569,0,0,0-.9,1.43,5.127,5.127,0,0,0-.34,1.782Q8.27,19.03,9.91,20.237a6.976,6.976,0,0,0,3.75,1.348,1.934,1.934,0,0,0-.48.633,3.414,3.414,0,0,0-.293.984,3.316,3.316,0,0,1-1.594.293,2.42,2.42,0,0,1-1.9-1.3,3.234,3.234,0,0,0-.645-0.75,1.767,1.767,0,0,0-1.184-.469q-0.7.023-.527,0.3a1.324,1.324,0,0,0,.551.469,2.583,2.583,0,0,1,.75.82,5.653,5.653,0,0,1,.469.867,2.2,2.2,0,0,0,.984,1.172,4.5,4.5,0,0,0,3.047.258l0.023,2.227a0.648,0.648,0,0,1-.187.457,0.686,0.686,0,0,1-.633.129A12.083,12.083,0,0,1,6.16,23.366,12,12,0,0,1,24.336,7.791Z" transform="translate(-3.84 -4.287)"/>
  </symbol>
  <symbol id="icons-life-preserver" viewBox='0 0 18 18'>
    <path d="M9,17A8,8,0,1,0,1,9,8,8,0,0,0,9,17ZM9,5A4,4,0,1,1,5,9,4,4,0,0,1,9,5Z" transform="translate(-1 -1)" fill="#fff"/><path d="M9,2A7,7,0,1,1,2,9,7.008,7.008,0,0,1,9,2M9,13.5A4.5,4.5,0,1,0,4.5,9,4.505,4.505,0,0,0,9,13.5M9,1a8,8,0,1,0,8,8A8,8,0,0,0,9,1H9ZM9,12.5A3.5,3.5,0,1,1,12.5,9,3.5,3.5,0,0,1,9,12.5H9Z" transform="translate(-1 -1)"/><path d="M5.259,7.623A3.989,3.989,0,0,1,7.623,5.259L4.654,2.289A8.032,8.032,0,0,0,2.29,4.653Z" transform="translate(-1 -1)"/><path d="M12.741,10.377a3.989,3.989,0,0,1-2.364,2.364l2.969,2.969a8.032,8.032,0,0,0,2.364-2.364Z" transform="translate(-1 -1)"/><path d="M7.623,12.741a3.989,3.989,0,0,1-2.364-2.364L2.289,13.346A8.032,8.032,0,0,0,4.653,15.71Z" transform="translate(-1 -1)"/><path d="M10.377,5.259a3.989,3.989,0,0,1,2.364,2.364l2.969-2.969A8.032,8.032,0,0,0,13.347,2.29Z" transform="translate(-1 -1)"/>
  </symbol>
  <symbol id="icons-overflow" viewBox="0 0 18 4.688">
    <path fill="currentColor" d="M2.344,7.656A1.344,1.344,0,1,1,1,9,1.345,1.345,0,0,1,2.344,7.656m0-1A2.344,2.344,0,1,0,4.688,9,2.344,2.344,0,0,0,2.344,6.656h0Z" transform="translate(0 -6.656)"/><path fill="currentColor" d="M9,7.656A1.344,1.344,0,1,1,7.656,9,1.345,1.345,0,0,1,9,7.656m0-1A2.344,2.344,0,1,0,11.344,9,2.344,2.344,0,0,0,9,6.656H9Z" transform="translate(0 -6.656)"/><path fill="currentColor" d="M15.656,7.656A1.344,1.344,0,1,1,14.313,9a1.345,1.345,0,0,1,1.344-1.344m0-1A2.344,2.344,0,1,0,18,9a2.344,2.344,0,0,0-2.344-2.344h0Z" transform="translate(0 -6.656)"/>
  </symbol>
</svg>

    <header class="grid-block shrink header">
  <div class="grid-block grid-container justify-justified">
    <a href="/" class="grid-block align-center shrink logo">
      <img class="img" src="https://runnable.com/images/runnable-logo.svg" height="36" width="192">
    </a>
    <nav class="nav grid-block shrink">
      <div class="grid-content btn btn-sm text-white weight-strong hidden-xs a popover-trigger hover has-links" tabindex="1">
        <div class="div">Features
          <svg class="icons icons-chevron-down">
            <use xlink:href="#icons-chevron-down">
          </svg>
        </div>
        <div class="popover-hover-wrapper popover-feature">
  <div class="grid-block col list text-left popover popover-header-menu bottom">
    <a href="/preview-environments/" class="grid-block align-center a padding-sm">
      <img src="/blog/images/icons-staging.svg" height="45" width="45" class="img">
      <div class="grid-block col">
        <p class="p weight-strong">Preview Environments</p>
        <p class="small">Isolated, full-stack environments for every branch.</p>
      </div>
    </a>
    <a href="/end-to-end-testing/" class="grid-block align-center a padding-sm">
      <img src="/blog/images/icons-testing.svg" height="45" width="45" class="img">
      <div class="grid-block col">
        <p class="p weight-strong">End-to-end Testing</p>
        <p class="small">Test every code change on its own preview environment.</p>
      </div>
    </a>
    <a href="/deploy-to-production/" class="grid-block align-center a padding-sm">
      <img src="/blog/images/icons-deploy.svg" height="45" width="45" class="img">
      <div class="grid-block col">
        <p class="p weight-strong">Deploy to Production</p>
        <p class="small">Deploy fully-tested builds to any environment.</p>
      </div>
    </a>
  </div>
</div>

      </div>
      <a href="/docs/" class="grid-content btn btn-sm text-white weight-strong hidden-sm a">Docs</a>
      <a href="/pricing/" class="grid-content btn btn-sm text-white weight-strong hidden-md">Pricing</a>
      <a href="/signup/" class="grid-content btn btn-sm btn-white text-white weight-strong hidden-xs track-sign-up">Sign Up</a>
      <div class="grid-content btn btn-sm btn-overflow popover-trigger hover has-links" tabindex="1">
        <svg class="icons icons-overflow">
          <use xlink:href="#icons-overflow">
        </svg>
        <div class="popover-hover-wrapper right-align-sm">
  <div class="grid-block popover popover-header-menu bottom">
    <div class="grid-block col list text-left">
      <small class="small visible-xs text-gray-light margin-left-sm">Features</small>
      <a href="/preview-environments/" class="grid-block align-center list-item-a list-item-feature visible-xs">
        <img src="/blog/images/icons-staging.svg" height="30" width="30" class="img">
        Preview Environments
      </a>
      <a href="/end-to-end-testing/" class="grid-block align-center list-item-a list-item-feature visible-xs">
        <img src="/blog/images/icons-testing.svg" height="30" width="30" class="img">
        End-to-end Testing
      </a>
      <a href="/deploy-to-production/" class="grid-block align-center list-item-a list-item-feature visible-xs">
        <img src="/blog/images/icons-deploy.svg" height="30" width="30" class="img">
        Deploy to Production
      </a>
      <div class="list-item divider visible-xs"></div>
      <a href="/signup/" class="list-item-a visible-xs track-sign-up">Sign Up</a>
      <div class="list-item divider visible-md"></div>
      <a href="/docs/" class="list-item-a visible-sm">Docs</a>
      <a href="/pricing/" class="list-item-a visible-md">Pricing</a>
      <a href="/how-it-works/" class="list-item-a">How It Works</a>
      <a href="/use-cases/" class="list-item-a">Use Cases</a>
      <a href="/blog/" class="list-item-a">Blog</a>
      <a href="/contact/" class="list-item-a">Contact</a>
      <a href="/about/" class="list-item-a">About</a>
    </div>
  </div>
</div>

      </div>
    </div>
  </nav>
</header>


    <main class="grid-block col main">
      <div class="grid-block col align-center hero hero-post"></div>

<div class="grid-block grid-container col noscroll">
  <div class="grid-block align-center col post-details">
    <h1 class="h1 text-center weight-strong margin-top-sm post-title">External API Caching with Varnish & Nginx</h1>
    
    <img class="avatar" src="images/authors/ryanrichards.jpg" width="45" height="45">
    <div>by <a class="link" href="/blog/ryan-sandor-richards">Ryan Sandor Richards</a></div>
    <div><time class="time-capitalize" datatime="2016-05-31 00:00:00 -0700">2016-05-31 00:00:00 -0700</time> in Engineering</div>
    <div class="grid-block social-sharing" data-url="https://runnable.com/blog/external-api-caching-with-varnish-nginx" data-legacy-url="http://blog.runnable.com/post/144975295096/external-api-caching-with-varnish-nginx">
      <a target="_blank" href="https://twitter.com/intent/tweet?text=External API Caching with Varnish & Nginx&url=https://runnable.com/blog/external-api-caching-with-varnish-nginx&via=GetRunnable" class="share-item share-twitter">
        <img src="images/logos/logo-twitter.svg" width="20" height="20">
        <span class="share-count small">0</span>
      </a>
      <a target="_blank" href="https://www.linkedin.com/shareArticle?mini=true&url=https://runnable.com/blog/external-api-caching-with-varnish-nginx" class="share-item share-linkedin">
        <img src="images/logos/logo-linkedin.svg" width="20" height="20">
        <span class="share-count small">0</span>
      </a>
      <a target="_blank" href="#" class="share-item share-hackernews hidden">
        <img src="images/logos/logo-hackernews.svg" width="20" height="20">
        <span class="share-count small">0</span>
      </a>
    </div>
  </div>
  <article class="article article-body">
    <p class="p">We use a number of external services to handle data retrieval, monitoring, and reporting. The importance of each service depends on its role in our sandboxes product. For instance, it’s generally fine if we miss a few reports sent to Datadog but it is not okay if we are unable to reach the GitHub API. In this post, we’ll discuss the issues we’ve faced when interfacing with external services and dive into how we use Varnish Cache to handle them.</p>

<h3 class="h3">Three Problems</h3>

<p class="p">We’ve faced three major problems concerning external services during the course of building out the Runnable sandboxes product:</p>

<ol class="ol"><li class="li"><span class="strong">Latency</span> — the amount of time it takes for the service to handle our requests.</li>
<li class="li"><span class="strong">Availability</span> — whether or not the service can be used and is not experiencing an outage.</li>
<li class="li"><span class="strong">Rate Limiting</span> — whether or not we have hit the maximum number of requests allowed by the provider.</li>
</ol>

<p class="p">From our perspective, latency is a tough problem since there is often little we can do to address it directly <a href="#footnote-1" class="link" id="footnote-1-source">[1]</a>. Similarly we are, for the most part <a href="#footnote-2" class="link" id="footnote-2-source">[2]</a>, powerless to directly fix service outages. Which leaves us with rate limiting, the only problem we can directly address when designing our software.</p>

<p class="p">Since we’ve moved to a microservice architecture, outbound requests can come from a variety of sources and it can be difficult to directly track and optimize our usage. Furthermore, even if we were able to achieve an optimal minimum, the number of external requests in our system is directly proportional to number of active users. This means as we grow we will make more requests, and eventually we will hit the limits set forth by our external service providers.</p>

<p class="p">There were many ways we could go about solving the rate limiting problem, but the one that seemed most promising (and familiar) was to use a distributed HTTP cache, like <a href="https://www.varnish-cache.org/" class="link">Varnish Cache</a>.</p>

<h3 class="h3">Caching Outside of the Box</h3>

<p class="p">Varnish is a very fast “caching HTTP reverse proxy” <a href="#footnote-3" class="link" id="footnote-3-source">[3]</a> that has seen a lot of success as an in-datacenter frontend for any HTTP based service (APIs, web servers, etc.). In the standard use-case one simply sets a varnish server in front of one or many backend web services, customizes how caching and proxying works via a VCL configuration, then sets memory limits on the LRU cache during the daemon start.</p>

<p><img src="images/posts/varnish-1.png" class="img post-graphic" width="427" height="150" alt="image" /></p>

<p class="p">Once running, Varnish will handle all incoming requests on behalf of the application server. When the first request is made to a cacheable resource, it will forward the request to the application server, cache the response, and then send the response back to the end user. Subsequent requests to the same resource will bypass application server entirely and Varnish will simply respond with the cached content. Finally after a manual purge, timeout, or via LRU, the content for the resource will be removed from the cache, and the cycle will begin anew.</p>

<p class="p">By flipping this standard use case around, using the right VCL configuration, and relying on some advanced Varnish features, we can address all three problems discussed in the previous section.</p>

<p><img src="images/posts/varnish-2.png" class="img post-graphic" width="430" height="150" alt="image" /></p>

<p class="p"><span class="strong">Latency</span> is a problem that can be directly solved by putting varnish between internal services and external APIs <a href="#footnote-4" class="link" id="footnote-4-source">[4]</a>. Given that the data remains relatively static (persists longer than a minute or two), one can bypass external requests entirely. This has the effect of dramatically reducing latency when fetching external resources <a href="#footnote-5" class="link" id="footnote-5-source">[5]</a>.</p>

<p class="p">We can partially address the problem of <span class="strong">availability</span> by way of a “<a href="https://www.varnish-cache.org/trac/wiki/VCLExampleGrace" class="link">grace periods</a>”. Roughly under certain circumstances (such as when it cannot reach backends) one can configure Varnish to serve stale content even if it has been purged or expired from the cache. This means that if the external service is having an outage, you can still get stale “responses” from the service and do as much as you can until things settle down.</p>

<p class="p">Finally, <span class="strong">rate limiting</span> is addressed in the exact same way as latency. If you have a decent cache hit ratio in Varnish, then you necessarily make fewer requests to the external service. This means that your service has much more breathing room to work with before hitting any eventual rate limits.</p>

<p class="p">From this perspective it’s pretty clear that Varnish is an excellent tool for the job. But there are still a couple of problems. First, we haven’t actually solved the rate limiting problem, but only made it less pressing by giving ourselves a bit more headroom. Second, Varnish does not handle SSL <a href="#footnote-6" class="link" id="footnote-6-source">[6]</a>, and nearly all external APIs one might want to leverage require the use of the <a href="https://en.wikipedia.org/wiki/HTTPS" class="link">HTTPS protocol</a> for secure communication.</p>

<h3 class="h3">Putting It All Together: NGINX + Multiple NATs</h3>

<p class="p">While Varnish doesn’t handle SSL, there is another HTTP proxy that does: NGINX. To make this work, we setup an Nginx instance that translates incoming HTTP traffic from Varnish to HTTPS traffic outbound to the external service. Then Nginx performs the SSL decryption of the response and sends it back to Varnish via HTTP.</p>

<p><img src="images/posts/varnish-3.png" class="img post-graphic" width="560" height="205" alt="image" /></p>

<p class="p">By using the two proxies together, one allows each to do what they do best. Furthermore the solution is actually rather trivial to implement with NGINX <a href="#footnote-7" class="link" id="footnote-7-source">[7]</a>.</p>

<p class="p">With SSL out of the way, the last problem to fully solve is rate limiting. If you are using a Software Defined Networking solution (e.g. AWS VPC) for your production infrastructure, then one solution is to route outbound traffic through different NATs. In this scheme, one sends high priority requests through one NAT, and low priority requests through another.</p>

<p><img src="https://s3-us-west-1.amazonaws.com/runnable-design/varnish-4.png" class="img post-graphic" width="866" height="395" alt="image" /></p>

<p class="p">For instance, HTTP services could be considered high priority, and worker based services could be considered low priority. HTTP services such as internal or external APIs often do not have retry logic built into routes when external calls fail, but worker servers can be easily coded to use a backoff scheme and retry their task at a later date.</p>

<h3 class="h3">Final Thoughts</h3>

<p class="p">While in no way the ultimate solution to handling external services we’re pretty happy with this solution at Runnable. It meets our needs, leverages open source, and is modular enough to easily change in the future. Thanks for reading and happy architecting!</p>

<p id="footnote-1" class="footnote">1: Network latency is directly proportional to the distance between our datacenter and the external service’s datacenter. Request processing time depends on the implementation details of the service in question. <a href="#footnote-1-source" class="link">↩</a></p>

<p id="footnote-2" class="footnote">2: One way we help is to <a href="introducing-ponos-a-rabbitmq-based-worker-server" class="link">exponentially backoff</a> requests to failing providers so as to avoid DOSing them when they are already buckling under load. <a href="#footnote-2-source" class="link">↩</a></p>

<p id="footnote-3" class="footnote">3: <a href="https://www.varnish-cache.org/intro/index.html#intro" class="link">In-depth information on varnish</a> <a href="#footnote-3-source" class="link">↩</a></p>

<p id="footnote-4" class="footnote">4: Traditionally one uses it to reduce processing time for HTML rendering (via rails, php, etc.), but companies such as <a href="www.fastly.com" class="link">Fastly</a> even use Varnish to help reduce network latency! <a href="#footnote-4-source" class="link">↩</a></p>

<p id="footnote-5" class="footnote">5: By default one usually only caches HTTP GET and HEAD requests, as it often does not make sense to cache routes that perform resource mutation. <a href="#footnote-5-source" class="link">↩</a></p>

<p id="footnote-6" class="footnote">6: There are some <a href="https://www.varnish-cache.org/docs/trunk/phk/ssl_again.html" class="link">very good reasons</a> as to why this is the case <a href="#footnote-6-source" class="link">↩</a></p>

<p id="footnote-7" class="footnote">7: Here’s an example <a href="https://gist.github.com/rsandor/2dce300e5bd8f23f1084faf27b43ca24" class="link">SSL initiation configuration for NGINX</a> <a href="#footnote-7-source" class="link">↩</a></p>

  </article>

  <section class="grid-block shrink justify-center align-center section-footer">
    <a class="grid-block shrink link text-center padding-sm" href="/blog/">View All Posts</a>
  </section>
</div>

<script src="js/social-buttons.js"></script>

    </main>

    <footer class="grid-block col footer justify-spaced">
  <aside class="grid-block aside-support">
  <div class="grid-block col justify-center support-text">
    <p class="p weight-strong">Our engineers are here for you.</p>
    <p class="p">We can answer questions about Docker <br class="br">and help you set up your stack.</p>
  </div>
  <figure class="grid-block col figure shrink">
    <div class="grid-block shrink bubble">
      <img class="img float-left" src="/blog/images/logos/logo-slack.svg" height="18" width="18" alt="Slack">
      <div class="grid-block col">
        <div class="user">
          <strong class="strong user-name">Jorge</strong>
          <span class="user-time"> 4:19 PM</span>
        </div>
        <p class="p user-text">Can I run multiple commands?</p>
      </div>
    </div>
    <div class="grid-block shrink bubble">
      <img class="img float-left" src="/blog/images/runnabot-head.png" height="18" width="18" alt="Slack">
      <div class="grid-block col">
        <div class="user">
          <strong class="strong user-name">Taylor</strong>
          <span class="user-time"> 4:20 PM</span>
        </div>
        <p class="p user-text">Hi <span class="link-blue">@jorge</span>!
          <br>Yes you can. Here’s how: …
        </p>
      </div>
    </div>
  </figure>
</aside>

  <div class="grid-block link-wrapper">
    <div class="grid-block col align-start">
      <h4 class="h4">Product</h4>
      <a href="/preview-environments/" class="a">Preview Environments</a>
      <a href="/end-to-end-testing/" class="a">End-to-End Testing</a>
      <a href="/deploy-to-production/" class="a">Deploy to Production</a>
      <a href="/use-cases/" class="a">Use Cases</a>
      <a href="/how-it-works/" class="a">How It Works</a>
      <a href="/pricing/" class="a">Pricing</a>
      <h4 class="h4 margin-top-sm">Help</h4>
      <a href="/docs/" class="a">Docs</a>
      <a href="/docker/" class="a">Docker Guides</a>
    </div>
    <div class="grid-block col align-start">
      <h4 class="h4">Company</h4>
      <a href="/about/" class="a">About</a>
      <a href="/blog/" class="a">Blog</a>
      <a href="/contact/" class="a">Contact</a>
      <a href="https://www.facebook.com/runnable/" class="a">Facebook</a>
      <a href="https://twitter.com/GetRunnable" class="a">Twitter</a>
      <a href="https://www.linkedin.com/company/runnable" class="a">Linkedin</a>
      <h4 class="h4 margin-top-sm">Legal</h4>
      <a href="/legal/privacy-policy/" class="a">Privacy</a>
      <a href="/legal/terms-of-service/" class="a">Terms</a>
      <a href="/legal/acceptable-use-policy/" class="a">Acceptable Use</a>
    </div>
  </div>
</footer>

  </body>

</html>
